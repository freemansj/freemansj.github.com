---
title: 浅谈-Https
date: 2018-04-17 17:01:37
tags: 
  - Https
categories:
  - WEB安全
---

>{% blockquote [No Name] %}
	在夹缝中寻求转机...
{% endblockquote %}

<!--more -->

---

### 首先 为何需要Https? 

 看情况，有些情况下确实不需要Https，它耗费较多的计算资源（加密解密）也好，资金（购买证书的花费）也罢，在不需要安全传输的时候，不用反而更自在。但是 当你要交换一些私人的重要信息（如密码）时，那就得考虑一下Https 了。

---

### 接下来谈谈历史....

原先，大家都使用http，然后，有一天，有人发现可以轻松地截获http，然后窥探其中的内容，甚至修改其中的内容，给原先通信的双方带来威胁。问题既然出现了，那就解决它咯。

有人想出了一种感觉不错的方案：让通信双方协商一种加密规则（`对称密钥`），每次发送信息时都先经过这一规则进行加密，接收端进行解密 获取最终信息，这样 就算`中间人`截获了请求，也不知道里面的内容該如何解析。

然而，很快就被发现其中的缺陷，那就是，通信双方可能在 交换密钥的时候，就被截取了请求，中间人知道了密钥，甚至将密钥偷偷换成自己的，然后 同时和通信双方 用自己的伪造密钥 进行通信。

---

又有人想到，是否可以使用`非对称的加密`，即 通信双方都保留一个`密钥对`，一个公钥，一个私钥，公钥发送给对方，让对方使用公钥进行加密，自己再用私钥进行解密。

然而，还是有上述的问题（中间人只要将其中双方发给对方的公钥都换成自己的公钥就行）。。。因为，**根本的问题并没有被解决，就是如何将 对称密钥 或者 自己的公钥 正确地交到对方手上？ http请求很难避免被截获， 我们只能从另一个方向努力，即 让中间人就算截获到请求也不知道内容是什么，还有一旦中间人更改了请求的内容，通信方能够感知到。**

---

首先有人想到的是 使用 `证书`，它由一个可信赖的第三方来颁发，证书中包含公钥和通信方的信息。这样，通过第三方来证明 和A通信的确实是B 而不是C。 不错的想法，然而还是没能解决问题，因为中间人可能成功篡改证书，那么证书有没有都没差了。。。

---

后来，有人发现有一类 `hash算法`（常见MD5/SHA1/SHA256） 可以基于 某些信息 生成一个`消息摘要`。使用这种hash算法，一旦信息发生了改变，生成的消息摘要便会 大不相同【单向不可逆、对输入非常敏感、输出长度固定】。哦噢，这可大有可为了。如果用它来加密证书中的信息，那么便不用担心证书被修改了吧？ 然而，还是天真了，如果将整个信息全部替换，用一样的hash算法伪造一个新的消息摘要，那么通信的另一方还是无法辨别真伪（毕竟他主要通过同样的hash算法基于 证书信息 生成消息摘要，再对比消息摘要的异同）。。。何解？

---

前面提到了 一个 可信赖的第三方，他们一般被称为 `CA(Certification Authority)`, 他们提出了一种方案，首先，服务器方应向他们申请 证书（赚钱的套路），内容可以是 基于 公钥+服务器方的一些必要信息【后面简称为原始数据】生成的消息摘要。申请成功，CA便会用他们的私钥对消息摘要进行签名，服务器方将签名结果加在原始数据后面【称为`数字签名`】，一起发给客户端。**客户端接收到这个数据包后，首先，使用CA的公钥对 签名结果 进行解密，还原出消息摘要MS1 ,  然后 使用同样的hash算法 基于 原始数据 生成消息摘要 MS2, 只要MS1与MS2相同，那么便可以认定 原始数据未被修改过。。。**

> 再问：客户端是如何获取 CA的公钥的？ 
一般主流的浏览器/操作系统中都会先内置 主流/顶级 的CA的公钥。

---

### 着眼于 效率

OK, 安全问题到此基本解决了，我们可以稍稍放心使用https来保证我们的通信安全了。

但是，非对称加密的效率问题仍在困扰着人们。 通常的方案是使用非对称加密传输来交换 对称密钥:

	1. 服务端 通过上述方式（数字签名），成功将自己的公钥交付到客户端
	2. 客户端 （随机或者其他方式）生成一个用于后续数据交换的对称密钥，用服务端传过来的公钥 对此信息进行加密，然后发送给服务端。
	3. 服务端 用自己的私钥解密 得到 对称密钥，之后和客户端使用該密钥进行数据交换。

整体的流程 如下图所示:(图片来源网络)

{% qnimg https1.png 'class:tcp-pic' extend:?imageView2/0/w/800/q/100|imageslim %}

---

度过了 夹杂欣喜、劳累、茫然、紧张、空洞 的一个月时间，平复一下心情，重新回到轨道上来 ...